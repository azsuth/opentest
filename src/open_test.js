const {
  checkFileExtension,
  checkDocumentPath,
  showErrorMessage
} = require("./errors");
const { promptFileName, promptDocument } = require("./prompts");
const { openDocument, createNewFile } = require("./file_actions");
const { getFileInformation, getFilesInFolder } = require("./file_info");
const { CREATE_NEW_TEST_FILE, FILE_DOES_NOT_EXIST } = require("./constants");

function openTestForDocument(document) {
  Promise.resolve({ document })
    .then(checkFileExtension)
    .then(checkDocumentPath)
    .then(getFileInformation)
    .then(openDocument)
    .catch(fileDoesNotExist)
    .then(getFilesInFolder)
    .then(promptDocument)
    .then(openDocument)
    .catch(createNewFileSelected)
    .then(promptFileName)
    .then(createNewFile)
    .then(openDocument)
    .catch(showErrorMessage);
}

function fileDoesNotExist(args) {
  const { errorCode } = args;

  if (errorCode === FILE_DOES_NOT_EXIST) {
    return args;
  }

  throw args;
}

function createNewFileSelected(args) {
  const { errorCode } = args;

  if (errorCode === CREATE_NEW_TEST_FILE) {
    return args;
  }

  throw args;
}

module.exports = {
  openTestForDocument
};
