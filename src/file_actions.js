const vscode = require("vscode");

const defaultTestText = require("./default_test_text");
const {
  GENERIC_ERROR_WITH_MESSAGE,
  FILE_DOES_NOT_EXIST
} = require("./constants");

function createNewFile(args) {
  const { testFolderPath, newFileName, importPath } = args;
  const newFileUri = vscode.Uri.file(`${testFolderPath}/${newFileName}`);

  const edit = new vscode.WorkspaceEdit();
  edit.createFile(newFileUri);
  edit.insert(
    newFileUri,
    new vscode.Position(0, 0),
    defaultTestText(importPath)
  );

  return vscode.workspace.applyEdit(edit).then(
    fulfilled => {
      if (fulfilled) {
        return { ...args, testFileName: newFileName };
      }

      throw {
        ...args,
        errorCode: GENERIC_ERROR_WITH_MESSAGE,
        errorMessage: "Unable to create new file"
      };
    },
    reason => {
      throw {
        ...args,
        errorCode: GENERIC_ERROR_WITH_MESSAGE,
        errorMessage: reason
      };
    }
  );
}

function openDocument(args) {
  const { testFolderPath, testFileName } = args;
  const fileToOpen = `${testFolderPath}/${testFileName}`;

  return vscode.workspace.openTextDocument(fileToOpen).then(
    textDocument => {
      vscode.window.showTextDocument(textDocument, vscode.ViewColumn.Beside);
      throw { ...args, complete: true };
    },
    () => {
      throw { ...args, errorCode: FILE_DOES_NOT_EXIST };
    }
  );
}

module.exports = { createNewFile, openDocument };
